name: CI/CD

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Smoke test API
        run: |
          npm start &
          APP_PID=$!
          trap "kill $APP_PID" EXIT
          sleep 3
          curl --fail http://localhost:3002/api/location

  docker-build:
    runs-on: ubuntu-latest
    needs: ci
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t tracker-dashboard:ci .

  deploy:
    runs-on: ubuntu-latest
    environment: DEPLOY
    needs:
      - ci
      - docker-build
    if: always() && (github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main'))
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate deploy secrets
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          set -e
          [ -n "$SSH_HOST" ] || { echo "Missing secret: SSH_HOST"; exit 1; }
          [ -n "$SSH_USER" ] || { echo "Missing secret: SSH_USER"; exit 1; }
          [ -n "$SSH_PRIVATE_KEY" ] || { echo "Missing secret: SSH_PRIVATE_KEY"; exit 1; }
          case "$SSH_HOST" in
            *://*|*/*)
              echo "SSH_HOST must be just a hostname or IP (no http://, https://, path, or slash)"
              exit 1
              ;;
          esac
          echo "$SSH_PRIVATE_KEY" | grep -q "PRIVATE KEY" || { echo "SSH_PRIVATE_KEY does not look like a private key"; exit 1; }

      - name: Copy project files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          source: "./*"
          target: "~/tracker-dashboard"

      - name: Deploy to server over SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            set -e
            cd "$HOME/tracker-dashboard"
            docker compose up -d --build --remove-orphans
