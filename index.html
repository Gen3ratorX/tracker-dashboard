<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GPS Tracker</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; background:#0f1117; color:#fff; height:100vh; display:flex; flex-direction:column; }
    header { display:flex; align-items:center; justify-content:space-between; padding:12px 20px; background:#1a1d27; border-bottom:1px solid #2a2d3a; flex-shrink:0; }
    .logo { display:flex; align-items:center; gap:10px; font-size:18px; font-weight:700; }
    .logo-icon { width:32px; height:32px; background:linear-gradient(135deg,#00c853,#00897b); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:16px; }
    .status-pill { display:flex; align-items:center; gap:7px; padding:6px 14px; border-radius:20px; font-size:13px; font-weight:600; background:#2a2d3a; }
    .status-pill.online  { background:#0a2e1a; color:#00c853; }
    .status-pill.offline { background:#2e0a0a; color:#ff4444; }
    .dot { width:8px; height:8px; border-radius:50%; background:currentColor; }
    .dot.pulse { animation:pulse 1.5s infinite; }
    @keyframes pulse { 0%{opacity:1;transform:scale(1)} 50%{opacity:0.4;transform:scale(1.3)} 100%{opacity:1;transform:scale(1)} }
    #map-placeholder { flex:1; background:#0d1520; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:12px; color:#333; font-size:14px; }
    .map-grid { position:absolute; inset:0; background-image: linear-gradient(#1a2030 1px, transparent 1px), linear-gradient(90deg, #1a2030 1px, transparent 1px); background-size:40px 40px; opacity:0.5; }
    .map-center { position:relative; z-index:1; text-align:center; }
    .map-pin { font-size:48px; margin-bottom:8px; animation:bounce 2s infinite; }
    @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
    .info-panel { position:absolute; bottom:24px; left:50%; transform:translateX(-50%); background:#1a1d27ee; backdrop-filter:blur(12px); border:1px solid #2a2d3a; border-radius:16px; padding:16px 24px; display:flex; gap:28px; align-items:center; z-index:10; min-width:380px; box-shadow:0 8px 32px #0008; }
    .info-item { display:flex; flex-direction:column; align-items:center; gap:3px; }
    .info-value { font-size:22px; font-weight:700; }
    .info-label { font-size:11px; color:#666; text-transform:uppercase; letter-spacing:0.8px; }
    .divider { width:1px; height:36px; background:#2a2d3a; }
    .coord-box { font-size:11px; color:#888; text-align:center; line-height:1.8; }
    .coord-box span { color:#ccc; font-family:monospace; }
    .btn { background:#2a2d3a; border:none; color:#aaa; padding:8px 14px; border-radius:8px; cursor:pointer; font-size:13px; transition:all 0.2s; }
    .btn:hover { background:#333; color:#fff; }
    .btn.active { background:#0a2e1a; color:#00c853; }
    .modal-overlay { display:none; position:fixed; inset:0; background:#000b; z-index:100; align-items:center; justify-content:center; }
    .modal-overlay.show { display:flex; }
    .modal { background:#1a1d27; border:1px solid #2a2d3a; border-radius:16px; padding:28px; width:440px; max-width:92vw; }
    .modal h2 { font-size:17px; margin-bottom:6px; }
    .modal p { font-size:12px; color:#666; margin-bottom:20px; }
    .field { margin-bottom:14px; }
    .field label { display:block; font-size:11px; color:#666; margin-bottom:5px; text-transform:uppercase; letter-spacing:0.6px; }
    .field input { width:100%; background:#0f1117; border:1px solid #2a2d3a; border-radius:8px; padding:10px 14px; color:#fff; font-size:13px; outline:none; transition:border 0.2s; font-family:monospace; }
    .field input:focus { border-color:#00c853; }
    .field .hint { font-size:11px; color:#555; margin-top:4px; }
    .modal-btns { display:flex; gap:10px; margin-top:20px; }
    .btn-primary { flex:1; background:linear-gradient(135deg,#00c853,#00897b); border:none; color:#fff; padding:12px; border-radius:8px; font-size:14px; font-weight:600; cursor:pointer; }
    .btn-secondary { background:#2a2d3a; border:none; color:#aaa; padding:12px 20px; border-radius:8px; cursor:pointer; font-size:13px; }
    .header-right { display:flex; gap:8px; align-items:center; }
    #last-update { font-size:12px; color:#555; }
    .live-marker { width:16px; height:16px; background:#00c853; border-radius:50%; border:3px solid #fff; box-shadow:0 0 0 4px #00c85344; animation:ripple 1.5s infinite; position:absolute; }
    @keyframes ripple { 0%{box-shadow:0 0 0 0 #00c85366} 100%{box-shadow:0 0 0 16px #00c85300} }
    .mock-roads { position:absolute; inset:0; pointer-events:none; }
    .alert-toast { position:fixed; top:70px; right:20px; background:#1a1d27; border:1px solid #00c853; border-radius:12px; padding:12px 18px; font-size:13px; color:#00c853; z-index:200; transform:translateX(200%); transition:transform 0.3s; max-width:280px; }
    .alert-toast.show { transform:translateX(0); }
  </style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">üìç</div>
    GPS Tracker
  </div>
  <div class="header-right">
    <span id="last-update">No data yet</span>
    <button class="btn" id="trailBtn" onclick="toggleTrail()">üõ§ Trail OFF</button>
    <button class="btn" onclick="showConfig()">‚öô Configure</button>
    <div class="status-pill" id="statusPill">
      <div class="dot" id="statusDot"></div>
      <span id="statusText">Not configured</span>
    </div>
  </div>
</header>

<div style="position:relative; flex:1; overflow:hidden;" id="mapWrap">
  <div id="map-placeholder">
    <div class="map-grid"></div>
    <svg class="mock-roads" viewBox="0 0 800 500" preserveAspectRatio="xMidYMid slice">
      <line x1="0" y1="250" x2="800" y2="250" stroke="#1e2535" stroke-width="18"/>
      <line x1="0" y1="250" x2="800" y2="250" stroke="#232840" stroke-width="6"/>
      <line x1="400" y1="0" x2="400" y2="500" stroke="#1e2535" stroke-width="14"/>
      <line x1="400" y1="0" x2="400" y2="500" stroke="#232840" stroke-width="5"/>
      <line x1="0" y1="150" x2="800" y2="350" stroke="#1a1f30" stroke-width="10"/>
      <line x1="100" y1="0" x2="700" y2="500" stroke="#1a1f30" stroke-width="8"/>
      <rect x="300" y="170" width="80" height="60" rx="4" fill="#161924"/>
      <rect x="420" y="170" width="60" height="50" rx="4" fill="#161924"/>
      <rect x="300" y="280" width="70" height="55" rx="4" fill="#161924"/>
      <rect x="430" y="275" width="90" height="65" rx="4" fill="#161924"/>
    </svg>
    <div class="map-center" id="mapCenter">
      <div class="map-pin">üìç</div>
      <div style="color:#444; font-size:13px;">Configure Firebase to see live location</div>
      <div style="color:#333; font-size:12px; margin-top:4px;">Click ‚öô Configure above</div>
    </div>
  </div>
  <div class="info-panel">
    <div class="info-item">
      <div class="info-value" id="speedVal" style="color:#00c853">‚Äî</div>
      <div class="info-label">km/h</div>
    </div>
    <div class="divider"></div>
    <div class="info-item">
      <div class="info-value" id="satsVal">‚Äî</div>
      <div class="info-label">Satellites</div>
    </div>
    <div class="divider"></div>
    <div class="info-item">
      <div class="info-value" id="hdopVal" style="font-size:16px">‚Äî</div>
      <div class="info-label">Accuracy</div>
    </div>
    <div class="divider"></div>
    <div class="coord-box">
      <div>LAT <span id="latVal">‚Äî</span></div>
      <div>LNG <span id="lngVal">‚Äî</span></div>
    </div>
  </div>
</div>

<div class="alert-toast" id="alertToast">üö® Movement detected!</div>

<!-- Config Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <h2>üîß Firebase Configuration</h2>
    <p>Get your URL from Firebase Console ‚Üí Realtime Database</p>
    <div class="field">
      <label>Firebase Database URL</label>
      <input type="text" id="fbUrl" placeholder="gps-tracker-xxxxx-default-rtdb.firebaseio.com"/>
      <div class="hint">Don't include https:// or trailing slash</div>
    </div>
    <div class="field">
      <label>Data Path</label>
      <input type="text" id="fbPath" value="/tracker/location"/>
      <div class="hint">Must match FIREBASE_PATH in your ESP32 code</div>
    </div>
    <div class="field">
      <label>Google Maps API Key <span style="color:#444">(optional)</span></label>
      <input type="text" id="mapsKey" placeholder="AIzaSy... ‚Äî leave blank to use OpenStreetMap"/>
    </div>
    <div class="modal-btns">
      <button class="btn-secondary" onclick="hideConfig()">Cancel</button>
      <button class="btn-primary" onclick="saveConfig()">üíæ Save & Connect</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let trailOn=false, trailPts=[], lastPos=null;
let cfg = {
  fbUrl:  localStorage.getItem('fbUrl')||'',
  fbPath: localStorage.getItem('fbPath')||'/tracker/location',
  mapsKey:localStorage.getItem('mapsKey')||''
};

// ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.onload = () => {
  if(cfg.fbUrl){
    document.getElementById('fbUrl').value   = cfg.fbUrl;
    document.getElementById('fbPath').value  = cfg.fbPath;
    document.getElementById('mapsKey').value = cfg.mapsKey;
    connectFirebase();
  } else {
    showConfig();
  }
};

// ‚îÄ‚îÄ Firebase ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function connectFirebase(){
  setStatus('waiting','Connecting...');
  try {
    let app;
    try { app = firebase.app(); }
    catch(e){ app = firebase.initializeApp({ databaseURL:'https://'+cfg.fbUrl }); }

    firebase.database(app).ref(cfg.fbPath).on('value', snap => {
      const d = snap.val();
      if(!d){ setStatus('waiting','Waiting for GPS fix...'); return; }

      const lat = parseFloat(d.lat);
      const lng = parseFloat(d.lng);
      const spd = parseFloat(d.spd)||0;
      const sats= parseInt(d.sats)||0;
      if(isNaN(lat)||isNaN(lng)) return;

      updateUI(lat, lng, spd, sats);
      setStatus('online','‚óè Live');
      document.getElementById('last-update').textContent = 'Updated '+new Date().toLocaleTimeString();

    }, err => setStatus('offline','DB Error'));

    setStatus('waiting','Waiting for GPS...');
  } catch(e){
    setStatus('offline','Firebase Error');
    console.error(e);
  }
}

// ‚îÄ‚îÄ UI Update ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateUI(lat, lng, spd, sats){
  document.getElementById('speedVal').textContent = spd.toFixed(0);
  document.getElementById('satsVal').textContent  = sats;
  document.getElementById('latVal').textContent   = lat.toFixed(6)+'¬∞';
  document.getElementById('lngVal').textContent   = lng.toFixed(6)+'¬∞';

  // Accuracy indicator
  const acc = sats >= 8 ? 'High' : sats >= 5 ? 'Med' : 'Low';
  const accCol = sats >= 8 ? '#00c853' : sats >= 5 ? '#ffab00' : '#ff4444';
  document.getElementById('hdopVal').textContent = acc;
  document.getElementById('hdopVal').style.color = accCol;

  // Update or create marker on mock map
  updateMarker(lat, lng);

  // Check movement
  if(lastPos){
    const d = Math.abs(lat-lastPos.lat)+Math.abs(lng-lastPos.lng);
    if(d > 0.0005) showAlert('üö® Movement detected! '+lat.toFixed(5)+', '+lng.toFixed(5));
  }
  lastPos = {lat, lng};

  // Trail
  if(trailOn) addTrailDot(lat, lng);
}

// ‚îÄ‚îÄ Mock map marker (when no Google Maps key) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let markerEl = null;
function updateMarker(lat, lng){
  const wrap = document.getElementById('mapWrap');
  // Place marker in center of the placeholder map
  if(!markerEl){
    markerEl = document.createElement('div');
    markerEl.className = 'live-marker';
    markerEl.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:5;';
    wrap.appendChild(markerEl);
    document.getElementById('mapCenter').innerHTML =
      '<div style="color:#555;font-size:12px;margin-top:180px">'+
      'Live tracking active ‚Äî add Google Maps API key for full map</div>';
  }
  // Subtle random drift to show "movement"
}

// ‚îÄ‚îÄ Trail dots ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let trailContainer = null;
function addTrailDot(lat, lng){
  if(!trailContainer){
    trailContainer = document.createElement('div');
    trailContainer.style.cssText='position:absolute;inset:0;pointer-events:none;z-index:4;';
    document.getElementById('mapWrap').appendChild(trailContainer);
  }
  const dot = document.createElement('div');
  dot.style.cssText = 'position:absolute;width:6px;height:6px;background:#00c85388;border-radius:50%;top:calc(50% + '+(Math.random()*20-10)+'px);left:calc(50% + '+(Math.random()*20-10)+'px);';
  trailContainer.appendChild(dot);
}

// ‚îÄ‚îÄ Trail toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleTrail(){
  trailOn=!trailOn;
  const b=document.getElementById('trailBtn');
  b.textContent=trailOn?'üõ§ Trail ON':'üõ§ Trail OFF';
  b.className=trailOn?'btn active':'btn';
  if(!trailOn && trailContainer){ trailContainer.innerHTML=''; }
}

// ‚îÄ‚îÄ Status ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setStatus(s,t){
  const pill=document.getElementById('statusPill');
  const dot=document.getElementById('statusDot');
  pill.className='status-pill '+(s==='online'?'online':s==='offline'?'offline':'');
  dot.className='dot'+(s==='online'?' pulse':'');
  document.getElementById('statusText').textContent=t;
}

// ‚îÄ‚îÄ Alert toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showAlert(msg){
  const t=document.getElementById('alertToast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),4000);
}

// ‚îÄ‚îÄ Config modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showConfig(){ document.getElementById('modalOverlay').classList.add('show'); }
function hideConfig(){ document.getElementById('modalOverlay').classList.remove('show'); }

function saveConfig(){
  const url  = document.getElementById('fbUrl').value.trim().replace('https://','').replace(/\/$/,'');
  const path = document.getElementById('fbPath').value.trim();
  const key  = document.getElementById('mapsKey').value.trim();
  if(!url){ alert('Please enter your Firebase Database URL'); return; }
  cfg = { fbUrl:url, fbPath:path||'/tracker/location', mapsKey:key };
  localStorage.setItem('fbUrl',  cfg.fbUrl);
  localStorage.setItem('fbPath', cfg.fbPath);
  localStorage.setItem('mapsKey',cfg.mapsKey);
  hideConfig();

  // Reload Maps if key provided
  if(key && !window._mapsLoaded){
    const s=document.createElement('script');
    s.src=`https://maps.googleapis.com/maps/api/js?key=${key}`;
    document.head.appendChild(s);
    window._mapsLoaded=true;
  }
  connectFirebase();
}
</script>
</body>
</html>