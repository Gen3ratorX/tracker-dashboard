<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Node GPS Tracker</title>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; background:#0f1117; color:#fff; height:100vh; display:flex; flex-direction:column; }
    header { display:flex; align-items:center; justify-content:space-between; padding:12px 20px; background:#1a1d27; border-bottom:1px solid #2a2d3a; flex-shrink:0; z-index: 2000; }
    .logo { display:flex; align-items:center; gap:10px; font-size:18px; font-weight:700; }
    .logo-icon { width:32px; height:32px; background:linear-gradient(135deg,#00c853,#00897b); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:16px; }
    
    .status-pill { display:flex; align-items:center; gap:7px; padding:6px 14px; border-radius:20px; font-size:13px; font-weight:600; background:#2a2d3a; }
    .status-pill.online  { background:#0a2e1a; color:#00c853; }
    .status-pill.offline { background:#2e0a0a; color:#ff4444; }
    .dot { width:8px; height:8px; border-radius:50%; background:currentColor; }
    .dot.pulse { animation:pulse 1.5s infinite; }
    @keyframes pulse { 0%{opacity:1;transform:scale(1)} 50%{opacity:0.4;transform:scale(1.3)} 100%{opacity:1;transform:scale(1)} }
    
    /* Info Panel - Increased z-index so it sits above the map */
    .info-panel { position:absolute; bottom:24px; left:50%; transform:translateX(-50%); background:#1a1d27ee; backdrop-filter:blur(12px); border:1px solid #2a2d3a; border-radius:16px; padding:16px 24px; display:flex; gap:28px; align-items:center; z-index:1000; min-width:380px; box-shadow:0 8px 32px #0008; }
    .info-item { display:flex; flex-direction:column; align-items:center; gap:3px; }
    .info-value { font-size:22px; font-weight:700; }
    .info-label { font-size:11px; color:#666; text-transform:uppercase; letter-spacing:0.8px; }
    .divider { width:1px; height:36px; background:#2a2d3a; }
    .coord-box { font-size:11px; color:#888; text-align:center; line-height:1.8; }
    .coord-box span { color:#ccc; font-family:monospace; }
    
    .btn { background:#2a2d3a; border:none; color:#aaa; padding:8px 14px; border-radius:8px; cursor:pointer; font-size:13px; transition:all 0.2s; text-decoration: none; display: inline-block;}
    .btn:hover { background:#333; color:#fff; }
    .btn.active { background:#0a2e1a; color:#00c853; }
    .header-right { display:flex; gap:12px; align-items:center; }
    #last-update { font-size:12px; color:#555; }
    
    .alert-toast { position:fixed; top:70px; right:20px; background:#1a1d27; border:1px solid #00c853; border-radius:12px; padding:12px 18px; font-size:13px; color:#00c853; z-index:2000; transform:translateX(200%); transition:transform 0.3s; max-width:280px; }
    .alert-toast.show { transform:translateX(0); }

    /* Map Styling */
    #map { position: absolute; inset: 0; z-index: 1; background: #0f1117; }
    
    /* Magic CSS to make OpenStreetMap dark mode to match your dashboard! */
    .leaflet-tile {
        filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
    }
  </style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">üìç</div>
    Node GPS Tracker
  </div>
  <div class="header-right">
    <span id="last-update">No data yet</span>
    <button class="btn" id="trailBtn" onclick="toggleTrail()">üõ§ Trail OFF</button>
    <a href="#" id="mapsLink" target="_blank" class="btn">üó∫ Open in Google Maps</a>
    <div class="status-pill offline" id="statusPill">
      <div class="dot" id="statusDot"></div>
      <span id="statusText">Connecting...</span>
    </div>
  </div>
</header>

<div style="position:relative; flex:1; overflow:hidden;" id="mapWrap">
  <div id="map"></div>
  
  <div class="info-panel">
    <div class="info-item">
      <div class="info-value" id="speedVal" style="color:#00c853">‚Äî</div>
      <div class="info-label">km/h</div>
    </div>
    <div class="divider"></div>
    <div class="info-item">
      <div class="info-value" id="satsVal">‚Äî</div>
      <div class="info-label">Satellites</div>
    </div>
    <div class="divider"></div>
    <div class="info-item">
      <div class="info-value" id="hdopVal" style="font-size:16px">‚Äî</div>
      <div class="info-label">Accuracy</div>
    </div>
    <div class="divider"></div>
    <div class="coord-box">
      <div>LAT <span id="latVal">‚Äî</span></div>
      <div>LNG <span id="lngVal">‚Äî</span></div>
    </div>
  </div>
</div>

<div class="alert-toast" id="alertToast">üö® Movement detected!</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ‚îÄ‚îÄ Map Initialization ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let map = L.map('map').setView([0, 0], 2); // Start zoomed out
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap'
}).addTo(map);

let marker = L.marker([0, 0]); // We will add it to the map once we get the first coordinate
let polyline = L.polyline([], {color: '#00c853', weight: 4}).addTo(map);
let mapInitialized = false;

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let trailOn = false;
let lastPos = null;
let trailHistory = [];

// ‚îÄ‚îÄ Polling Node Server ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchLocation() {
    try {
        const response = await fetch('/api/location');
        const data = await response.json();

        if (data.lat !== 0 && data.lng !== 0) {
            updateUI(data.lat, data.lng, data.spd, data.sats);
            setStatus('online', '‚óè Server Live');
            document.getElementById('last-update').textContent = 'Updated: ' + data.time;
        } else {
            setStatus('offline', 'Awaiting GPS Fix');
        }
    } catch (error) {
        setStatus('offline', 'Server Offline');
        console.error("Fetch error:", error);
    }
}

// Start polling every 5 seconds
setInterval(fetchLocation, 5000);
fetchLocation();

// ‚îÄ‚îÄ UI Update ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateUI(lat, lng, spd, sats) {
  // Update Text
  document.getElementById('speedVal').textContent = spd.toFixed(1);
  document.getElementById('satsVal').textContent  = sats;
  document.getElementById('latVal').textContent   = lat.toFixed(6)+'¬∞';
  document.getElementById('lngVal').textContent   = lng.toFixed(6)+'¬∞';

  // The perfectly formatted Google Maps link!
  document.getElementById('mapsLink').href = `https://www.google.com/maps/search/?api=1&query=$${lat},${lng}`;

  const acc = sats >= 8 ? 'High' : sats >= 5 ? 'Med' : 'Low';
  const accCol = sats >= 8 ? '#00c853' : sats >= 5 ? '#ffab00' : '#ff4444';
  document.getElementById('hdopVal').textContent = acc;
  document.getElementById('hdopVal').style.color = accCol;

  // Update Real Map
  const newLatLng = [lat, lng];
  
  if (!mapInitialized) {
      marker.setLatLng(newLatLng).addTo(map);
      map.setView(newLatLng, 16); // Zoom in close to the car on the first ping
      mapInitialized = true;
  } else {
      marker.setLatLng(newLatLng);
      // Smoothly pan map to follow the car if it moves
      map.panTo(newLatLng);
  }

  // Handle Trail
  if (trailOn) {
      trailHistory.push(newLatLng);
      polyline.setLatLngs(trailHistory);
  }

  // Handle Alerts
  if(lastPos){
    const d = Math.abs(lat - lastPos.lat) + Math.abs(lng - lastPos.lng);
    if(d > 0.0005) showAlert('üö® Movement detected!');
  }
  lastPos = {lat, lng};
}

// ‚îÄ‚îÄ Trail Logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleTrail(){
  trailOn = !trailOn;
  const b = document.getElementById('trailBtn');
  b.textContent = trailOn ? 'üõ§ Trail ON' : 'üõ§ Trail OFF';
  b.className = trailOn ? 'btn active' : 'btn';
  
  if(!trailOn) {
      trailHistory = []; // Clear the memory
      polyline.setLatLngs([]); // Erase the line from the map
  }
}

// ‚îÄ‚îÄ UI Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setStatus(state, text){
  const pill = document.getElementById('statusPill');
  const dot = document.getElementById('statusDot');
  pill.className = 'status-pill ' + state;
  dot.className = 'dot' + (state === 'online' ? ' pulse' : '');
  document.getElementById('statusText').textContent = text;
}

function showAlert(msg){
  const t = document.getElementById('alertToast');
  t.textContent = msg; 
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 4000);
}
</script>
</body>
</html>